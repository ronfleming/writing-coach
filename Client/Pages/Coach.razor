@page "/"
@page "/coach"
@using Shared.Models
@using Client.Services
@inject CoachApiService CoachApi

<PageTitle>Writing Coach</PageTitle>

<div class="coach-container">
    <header class="coach-header">
        <div class="logo-container">
            <span class="logo-icon">üìù</span>
            <h1>Writing Coach</h1>
            <span class="logo-icon">‚ú®</span>
        </div>
        <p class="subtitle">Transform your German writing into natural, professional prose</p>
    </header>

    <div class="instructions-banner">
        <div class="instructions-quick">
            <strong>Quick Start:</strong> Paste your text ‚Üí Choose your context ‚Üí Click "Coach Me" ‚Üí Get corrections, improvements, and reusable phrases.
        </div>
        <details class="instructions-details">
            <summary>üìñ How it works</summary>
            <div class="instructions-content">
                <p><strong>1. Paste your text</strong> ‚Äî Any German writing you want to improve (emails, cover letters, messages).</p>
                <p><strong>2. Select your options:</strong></p>
                <ul>
                    <li><strong>Register</strong> ‚Äî How formal should the output be? (Colloquial for friends, Formal for business)</li>
                    <li><strong>Goal</strong> ‚Äî What do you want to achieve? (Correct errors, shorten, clarify, etc.)</li>
                    <li><strong>Context</strong> ‚Äî What kind of document is this? (Helps the AI understand tone expectations)</li>
                    <li><strong>Target Level</strong> ‚Äî Your target proficiency (B2, C1, etc.)</li>
                </ul>
                <p><strong>3. Review your results:</strong></p>
                <ul>
                    <li><strong>Minimal Fix</strong> ‚Äî Just the grammar/spelling corrections</li>
                    <li><strong>C1 Upgrade</strong> ‚Äî Natural, idiomatic, polished version</li>
                    <li><strong>Feedback</strong> ‚Äî Specific issues with memorable rules</li>
                    <li><strong>Phrase Bank</strong> ‚Äî Reusable expressions for your vocabulary</li>
                </ul>
            </div>
        </details>
    </div>

    <div class="input-section">
        <div class="form-group">
            <label for="textInput">Your Text</label>
            <textarea 
                id="textInput" 
                @bind="inputText" 
                @bind:event="oninput"
                placeholder="Paste your German text here..."
                rows="6"
                maxlength="5000"
                disabled="@isLoading"></textarea>
            <div class="char-count">@(inputText?.Length ?? 0) / 5000 characters</div>
        </div>

        <div class="options-row">
            <div class="form-group">
                <label for="register">Register</label>
                <select id="register" @bind="selectedRegister" disabled="@isLoading">
                    <option value="@Register.Colloquial">Colloquial</option>
                    <option value="@Register.Neutral">Neutral</option>
                    <option value="@Register.Formal">Formal</option>
                </select>
            </div>

            <div class="form-group">
                <label for="goal">Goal</label>
                <select id="goal" @bind="selectedGoal" disabled="@isLoading">
                    <option value="@Goal.Correct">Correct</option>
                    <option value="@Goal.Shorten">Shorten</option>
                    <option value="@Goal.Clarify">Clarify</option>
                    <option value="@Goal.Persuade">Persuade</option>
                    <option value="@Goal.Diplomatic">Diplomatic</option>
                </select>
            </div>

            <div class="form-group">
                <label for="context">Context</label>
                <select id="context" @bind="selectedContext" disabled="@isLoading">
                    <option value="@Context.General">General</option>
                    <option value="@Context.Recruiter">Recruiter Email</option>
                    <option value="@Context.CoverLetter">Cover Letter</option>
                    <option value="@Context.Behoerden">Beh√∂rden</option>
                    <option value="@Context.Landlord">Landlord</option>
                    <option value="@Context.Bank">Bank</option>
                    <option value="@Context.Insurance">Insurance</option>
                </select>
            </div>

            <div class="form-group">
                <label for="level">Target Level</label>
                <select id="level" @bind="selectedLevel" disabled="@isLoading">
                    <option value="@ProficiencyLevel.B1">B1</option>
                    <option value="@ProficiencyLevel.B2">B2</option>
                    <option value="@ProficiencyLevel.C1">C1</option>
                    <option value="@ProficiencyLevel.C2">C2</option>
                </select>
            </div>
        </div>

        <button class="coach-button" @onclick="SubmitAsync" disabled="@(isLoading || string.IsNullOrWhiteSpace(inputText))">
            @if (isLoading)
            {
                <span class="spinner"></span>
                <span>Analyzing...</span>
            }
            else
            {
                <span>üéØ Coach Me</span>
            }
        </button>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">
                ‚ö†Ô∏è @errorMessage
            </div>
        }
    </div>

    @if (response is not null)
    {
        <div class="results-section">
            <div class="result-card">
                <h2>‚úÖ Minimal Fix</h2>
                <p class="result-description">Grammar and spelling corrections only</p>
                <div class="result-text">@response.MinimalFix</div>
                <button class="copy-button" @onclick="() => CopyToClipboard(response.MinimalFix)">üìã Copy</button>
            </div>

            <div class="result-card featured">
                <h2>üöÄ C1 Upgrade</h2>
                <p class="result-description">Natural, idiomatic, register-appropriate</p>
                <div class="result-text">@response.C1Upgrade</div>
                <button class="copy-button" @onclick="() => CopyToClipboard(response.C1Upgrade)">üìã Copy</button>
            </div>

            @if (response.Variants is not null && HasVariants(response.Variants))
            {
                <div class="result-card">
                    <h2>üé≠ Style Variants</h2>
                    @if (!string.IsNullOrEmpty(response.Variants.Colloquial))
                    {
                        <div class="variant">
                            <strong>Colloquial:</strong>
                            <p>@response.Variants.Colloquial</p>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(response.Variants.Neutral))
                    {
                        <div class="variant">
                            <strong>Neutral:</strong>
                            <p>@response.Variants.Neutral</p>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(response.Variants.Formal))
                    {
                        <div class="variant">
                            <strong>Formal:</strong>
                            <p>@response.Variants.Formal</p>
                        </div>
                    }
                </div>
            }

            @if (response.Feedback.Count > 0)
            {
                <div class="result-card">
                    <h2>üìù Feedback</h2>
                    <div class="feedback-list">
                        @foreach (var item in response.Feedback)
                        {
                            <div class="feedback-item">
                                <div class="feedback-header">
                                    <strong>@item.Issue</strong>
                                    @if (!string.IsNullOrEmpty(item.Tag))
                                    {
                                        <span class="tag">@item.Tag</span>
                                    }
                                </div>
                                <p class="why-matters">@item.WhyItMatters</p>
                                <p class="quick-rule">üí° @item.QuickRule</p>
                                <code class="example">@item.Example</code>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (response.PhraseBank.Count > 0)
            {
                <div class="result-card">
                    <h2>üìö Phrase Bank</h2>
                    <p class="result-description">Reusable expressions from your text</p>
                    <table class="phrase-table">
                        <thead>
                            <tr>
                                <th>German</th>
                                <th>English</th>
                                <th>Case</th>
                                <th>Tags</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var phrase in response.PhraseBank)
                            {
                                <tr>
                                    <td><strong>@phrase.German</strong></td>
                                    <td>@phrase.English</td>
                                    <td>@(phrase.Case ?? "‚Äî")</td>
                                    <td>
                                        @foreach (var tag in phrase.Tags)
                                        {
                                            <span class="tag">@tag</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            @if (response.ErrorTags.Count > 0)
            {
                <div class="result-card">
                    <h2>üè∑Ô∏è Error Categories</h2>
                    <div class="tag-cloud">
                        @foreach (var tag in response.ErrorTags)
                        {
                            <span class="tag large">@tag</span>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private string? inputText;
    private Register selectedRegister = Register.Formal;
    private Goal selectedGoal = Goal.Correct;
    private Context selectedContext = Context.General;
    private ProficiencyLevel selectedLevel = ProficiencyLevel.C1;
    
    private bool isLoading = false;
    private string? errorMessage;
    private CoachResponse? response;

    private async Task SubmitAsync()
    {
        if (string.IsNullOrWhiteSpace(inputText))
            return;

        isLoading = true;
        errorMessage = null;
        response = null;

        try
        {
            var request = new CoachRequest
            {
                Text = inputText,
                Register = selectedRegister,
                Goal = selectedGoal,
                Context = selectedContext,
                TargetLevel = selectedLevel
            };

            response = await CoachApi.AnalyzeAsync(request);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private static bool HasVariants(StyleVariants variants)
    {
        return !string.IsNullOrEmpty(variants.Colloquial) 
            || !string.IsNullOrEmpty(variants.Neutral) 
            || !string.IsNullOrEmpty(variants.Formal);
    }

    private async Task CopyToClipboard(string text)
    {
        // Will implement with JS interop
        await Task.CompletedTask;
    }
}

