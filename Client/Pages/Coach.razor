@page "/"
@page "/coach"
@inject CoachApiService CoachApi
@inject IWebAssemblyHostEnvironment HostEnv

<PageTitle>Writing Coach - AI-Powered German Writing Assistant</PageTitle>

<HeadContent>
    <meta name="description" content="Transform your German writing into natural, professional prose. Get grammar corrections, C1-level upgrades, targeted feedback, and reusable phrases." />
    <meta property="og:title" content="Writing Coach - AI-Powered German Writing Assistant" />
    <meta property="og:description" content="Transform your German writing into natural, professional prose with AI-powered corrections and learning feedback." />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="/og-image.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Writing Coach - AI-Powered German Writing Assistant" />
    <meta name="twitter:description" content="Transform your German writing into natural, professional prose." />
    <link rel="canonical" href="https://writingcoach.app/" />
</HeadContent>

<div class="coach-container">
    <header class="coach-header">
        <div class="logo-container">
            <span class="logo-icon">‚úçÔ∏è</span>
            <h1>Writing Coach</h1>
            <span class="logo-icon">‚úçÔ∏è</span>
        </div>
        <p class="subtitle">Transform your German writing into natural, professional prose</p>
    </header>

    <div class="instructions-banner">
        <div class="instructions-quick">
            <strong>Quick Start:</strong> Paste your text ‚Üí Choose your context ‚Üí Click "Coach Me" ‚Üí Get corrections, improvements, and reusable phrases.
        </div>
        <details class="instructions-details">
            <summary>üìñ How it works</summary>
            <div class="instructions-content">
                <p><strong>1. Paste your text</strong> ‚Äî Any German writing you want to improve (emails, cover letters, messages).</p>
                <p><strong>2. Select your options:</strong></p>
                <ul>
                    <li><strong>Register</strong> ‚Äî How formal should the output be? (Colloquial for friends, Formal for business)</li>
                    <li><strong>Goal</strong> ‚Äî What do you want to achieve? (Correct errors, shorten, clarify, etc.)</li>
                    <li><strong>Context</strong> ‚Äî What kind of document is this? (Helps the AI understand tone expectations)</li>
                    <li><strong>Target Level</strong> ‚Äî Your target proficiency (B2, C1, etc.)</li>
                </ul>
                    <p><strong>3. Review your results:</strong></p>
                <ul>
                    <li><strong>Minimal Fix</strong> ‚Äî Just the grammar/spelling corrections</li>
                    <li><strong>Upgraded Text</strong> ‚Äî Natural, idiomatic, polished version for your target level</li>
                    <li><strong>Feedback</strong> ‚Äî Specific issues with memorable rules</li>
                    <li><strong>Phrase Bank</strong> ‚Äî Reusable expressions extracted from the improved text</li>
                </ul>
            </div>
        </details>
    </div>

    <div class="input-section">
        <div class="form-group">
            <label for="textInput">Your Text</label>
            <textarea 
                id="textInput" 
                @bind="inputText" 
                @bind:event="oninput"
                placeholder="Write or paste your German text here..."
                rows="6"
                maxlength="5000"
                disabled="@isLoading"></textarea>
            <div class="char-count">@(inputText?.Length ?? 0) / 5000 characters</div>
        </div>

        <div class="options-row">
            <div class="form-group">
                <label for="register">Register</label>
                <select id="register" @bind="selectedRegister" disabled="@isLoading">
                    <option value="@Register.Colloquial">Colloquial</option>
                    <option value="@Register.Neutral">Neutral</option>
                    <option value="@Register.Formal">Formal</option>
                </select>
            </div>

            <div class="form-group">
                <label for="goal">Goal</label>
                <select id="goal" @bind="selectedGoal" disabled="@isLoading">
                    <option value="@Goal.Correct">Correct</option>
                    <option value="@Goal.Shorten">Shorten</option>
                    <option value="@Goal.Clarify">Clarify</option>
                    <option value="@Goal.Persuade">Persuade</option>
                    <option value="@Goal.Diplomatic">Diplomatic</option>
                </select>
            </div>

            <div class="form-group">
                <label for="context">Context</label>
                <select id="context" @bind="selectedContext" disabled="@isLoading">
                    <option value="@Context.General">General</option>
                    <option value="@Context.Recruiter">Recruiter Email</option>
                    <option value="@Context.CoverLetter">Cover Letter</option>
                    <option value="@Context.Behoerden">Beh√∂rden</option>
                    <option value="@Context.Landlord">Landlord</option>
                    <option value="@Context.Bank">Bank</option>
                    <option value="@Context.Insurance">Insurance</option>
                </select>
            </div>

            <div class="form-group">
                <label for="level">Target Level</label>
                <select id="level" @bind="selectedLevel" disabled="@isLoading">
                    <option value="@ProficiencyLevel.A1">A1</option>
                    <option value="@ProficiencyLevel.A2">A2</option>
                    <option value="@ProficiencyLevel.B1">B1</option>
                    <option value="@ProficiencyLevel.B2">B2</option>
                    <option value="@ProficiencyLevel.C1">C1</option>
                    <option value="@ProficiencyLevel.C2">C2</option>
                </select>
            </div>

            <div class="form-group">
                <label for="model">AI Model</label>
                <select id="model" @bind="selectedModel" disabled="@isLoading">
                    @foreach (var (model, details) in AIModelInfo.All)
                    {
                        if (details.IsPremium && !isDev)
                        {
                            <option value="@model" disabled>üîí @details.DisplayName (requires account)</option>
                        }
                        else
                        {
                            <option value="@model">@details.DisplayName @(details.IsPremium ? "‚ö°" : "")</option>
                        }
                    }
                </select>
                <div class="model-info">@AIModelInfo.Get(selectedModel).Description ‚Äî @AIModelInfo.Get(selectedModel).ApproxCostPerRequest/req</div>
            </div>
        </div>

        <button class="coach-button" @onclick="SubmitAsync" disabled="@(isLoading || string.IsNullOrWhiteSpace(inputText))">
            @if (isLoading)
            {
                <span class="spinner"></span>
                <span>Analyzing...</span>
            }
            else
            {
                <span>üéØ Coach Me</span>
            }
        </button>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">
                ‚ö†Ô∏è @errorMessage
            </div>
        }
    </div>

    @if (response is not null)
    {
        <CoachResultDisplay Response="response" Level="selectedLevel" />
    }
</div>

@code {
    private string? inputText;
    private Register selectedRegister = Register.Formal;
    private Goal selectedGoal = Goal.Correct;
    private Context selectedContext = Context.General;
    private ProficiencyLevel selectedLevel = ProficiencyLevel.C1;
    private AIModel selectedModel = AIModel.Gpt41Mini;
    
    private bool isDev;
    private bool isLoading = false;
    private string? errorMessage;
    private CoachResponse? response;

    protected override void OnInitialized()
    {
        isDev = HostEnv.IsDevelopment();
    }

    private async Task SubmitAsync()
    {
        if (string.IsNullOrWhiteSpace(inputText))
            return;

        isLoading = true;
        errorMessage = null;
        response = null;

        try
        {
            var request = new CoachRequest
            {
                Text = inputText,
                Register = selectedRegister,
                Goal = selectedGoal,
                Context = selectedContext,
                TargetLevel = selectedLevel,
                Model = selectedModel
            };

            response = await CoachApi.AnalyzeAsync(request);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

}

