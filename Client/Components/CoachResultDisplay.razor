@inject IJSRuntime JS

@if (!string.IsNullOrEmpty(copyFeedback))
{
    <div class="copy-feedback">@copyFeedback</div>
}

<div class="results-section">
    <div class="result-card">
        <h2>‚úÖ Minimal Fix</h2>
        <p class="result-description">Grammar and spelling corrections only</p>
        <div class="result-text">@Response.MinimalFix</div>
        <button class="copy-button" @onclick="() => CopyToClipboard(Response.MinimalFix)">üìã Copy</button>
    </div>

    <div class="result-card featured">
        <h2>üöÄ @Level Upgrade</h2>
        <p class="result-description">Natural, idiomatic, register-appropriate</p>
        @if (!string.IsNullOrEmpty(Response.RegisterNote))
        {
            <div class="register-note">
                ‚ö†Ô∏è @Response.RegisterNote
            </div>
        }
        <div class="result-text">@Response.UpgradedText</div>
        <button class="copy-button" @onclick="() => CopyToClipboard(Response.UpgradedText)">üìã Copy</button>
        
        @if (Response.Alternative is not null)
        {
            <details class="alternative-section">
                <summary>üí° Alternative interpretation available</summary>
                <div class="alternative-content">
                    <p class="alternative-explanation">
                        <strong>Your phrase:</strong> "@Response.Alternative.OriginalPhrase"
                    </p>
                    <div class="interpretation-options">
                        <div class="interpretation">
                            <span class="interpretation-label">‚úì Shown above:</span>
                            <span>@Response.Alternative.PrimaryMeaning</span>
                        </div>
                        <div class="interpretation">
                            <span class="interpretation-label">‚óã Alternative:</span>
                            <span>@Response.Alternative.AlternativeMeaning</span>
                        </div>
                    </div>
                    <div class="alternative-text">
                        <strong>Alternative version:</strong>
                        <div class="result-text">@Response.Alternative.AlternativeText</div>
                    </div>
                </div>
            </details>
        }
    </div>

    @if (Response.Variants is not null && HasVariants(Response.Variants))
    {
        <div class="result-card">
            <h2>üé≠ Style Variants</h2>
            @if (!string.IsNullOrEmpty(Response.Variants.Colloquial))
            {
                <div class="variant">
                    <strong>Colloquial:</strong>
                    <p>@Response.Variants.Colloquial</p>
                </div>
            }
            @if (!string.IsNullOrEmpty(Response.Variants.Neutral))
            {
                <div class="variant">
                    <strong>Neutral:</strong>
                    <p>@Response.Variants.Neutral</p>
                </div>
            }
            @if (!string.IsNullOrEmpty(Response.Variants.Formal))
            {
                <div class="variant">
                    <strong>Formal:</strong>
                    <p>@Response.Variants.Formal</p>
                </div>
            }
        </div>
    }

    @if (Response.Feedback.Count > 0)
    {
        <div class="result-card">
            <h2>üìù Feedback</h2>
            <div class="feedback-list">
                @foreach (var item in Response.Feedback)
                {
                    <div class="feedback-item">
                        <div class="feedback-header">
                            <strong>@item.Issue</strong>
                            @if (!string.IsNullOrEmpty(item.Tag))
                            {
                                <span class="tag">@item.Tag</span>
                            }
                        </div>
                        <p class="why-matters">@item.WhyItMatters</p>
                        <p class="quick-rule">üí° @item.QuickRule</p>
                        <code class="example">@item.Example</code>
                    </div>
                }
            </div>
        </div>
    }

    @if (Response.PhraseBank.Count > 0)
    {
        <div class="result-card">
            <h2>üìö Phrase Bank</h2>
            <p class="result-description">Reusable patterns from the improved text</p>
            <table class="phrase-table">
                <thead>
                    <tr>
                        <th>Phrase / Pattern</th>
                        <th>Translation</th>
                        <th>Level</th>
                        <th>Tags</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var phrase in Response.PhraseBank)
                    {
                        <tr>
                            <td>
                                <strong>@phrase.Phrase</strong>
                                @if (!string.IsNullOrEmpty(phrase.Pattern))
                                {
                                    <br /><span class="pattern">@phrase.Pattern</span>
                                }
                            </td>
                            <td>@phrase.Translation</td>
                            <td>
                                @if (!string.IsNullOrEmpty(phrase.Level))
                                {
                                    <span class="tag">@phrase.Level</span>
                                }
                                else
                                {
                                    <span>‚Äî</span>
                                }
                            </td>
                            <td>
                                @foreach (var tag in phrase.Tags)
                                {
                                    <span class="tag">@tag</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @if (Response.ErrorTags.Count > 0)
    {
        <div class="result-card">
            <h2>üè∑Ô∏è Error Categories</h2>
            <div class="tag-cloud">
                @foreach (var tag in Response.ErrorTags)
                {
                    <span class="tag large">@tag</span>
                }
            </div>
        </div>
    }

    <div class="result-meta">
        @if (!string.IsNullOrEmpty(Response.ModelUsed))
        {
            <span>Model: @Response.ModelUsed</span>
        }
        @if (Response.Usage is not null)
        {
            <span>Tokens: @Response.Usage.InputTokens in / @Response.Usage.OutputTokens out (@Response.Usage.TotalTokens total)</span>
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public CoachResponse Response { get; set; } = default!;

    [Parameter]
    public ProficiencyLevel Level { get; set; } = ProficiencyLevel.C1;

    private string? copyFeedback;

    private static bool HasVariants(StyleVariants variants)
    {
        return !string.IsNullOrEmpty(variants.Colloquial) 
            || !string.IsNullOrEmpty(variants.Neutral) 
            || !string.IsNullOrEmpty(variants.Formal);
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            copyFeedback = "Copied!";
            StateHasChanged();
            await Task.Delay(1500);
            copyFeedback = null;
            StateHasChanged();
        }
        catch
        {
            copyFeedback = "Copy failed ‚Äî try selecting the text manually";
            StateHasChanged();
            await Task.Delay(2500);
            copyFeedback = null;
            StateHasChanged();
        }
    }
}

